name: GitHub Activity â†’ Discord

on:
  push:
    branches: [master, develop]
  pull_request:
    types: [opened, closed, reopened]
  release:
    types: [published]
  watch:
    types: [started]
  fork:

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Build payload & send to Discord
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          EVENT="${{ github.event_name }}"
          COLOR=3447003
          TITLE="ðŸ“¢ GitHub Activity"
          DESC=""
          AUTHOR="${{ github.actor }}"
          URL="https://github.com/${{ github.repository }}"

          if [ "$EVENT" = "push" ]; then
            TITLE="ðŸš€ New Push to ${{ github.ref_name }}"
            DESC="${{ github.event.head_commit.message }}"
            AUTHOR="${{ github.event.head_commit.author.name }}"
            URL="${{ github.event.compare }}"
            COLOR=65280
          fi

          if [ "$EVENT" = "pull_request" ]; then
            TITLE="ðŸ” Pull Request ${{ github.event.action }}"
            DESC="#${{ github.event.pull_request.number }} - ${{ github.event.pull_request.title }}"
            AUTHOR="${{ github.event.pull_request.user.login }}"
            URL="${{ github.event.pull_request.html_url }}"
            COLOR=16776960
          fi

          if [ "$EVENT" = "release" ]; then
            TITLE="ðŸ· New Release Published"
            DESC="Tag: ${{ github.event.release.tag_name }}"
            AUTHOR="${{ github.event.release.author.login }}"
            URL="${{ github.event.release.html_url }}"
            COLOR=10181046
          fi

          if [ "$EVENT" = "watch" ]; then
            TITLE="â­ New Star"
            DESC="Your repository was starred!"
            COLOR=15844367
          fi

          if [ "$EVENT" = "fork" ]; then
            TITLE="ðŸ´ Repository Forked"
            DESC="Someone forked your repository!"
            COLOR=15105570
          fi

          jq -n \
            --arg title "$TITLE" \
            --arg desc "$DESC" \
            --arg author "$AUTHOR" \
            --arg url "$URL" \
            --argjson color "$COLOR" \
            '{
              username: "GitHub Bot",
              embeds: [{
                title: $title,
                description: $desc,
                color: $color,
                url: $url,
                fields: [
                  {name: "ðŸ‘¤ Actor", value: $author, inline: true}
                ],
                footer: {text: "GitHub Notifications"},
                timestamp: (now | todate)
              }]
            }' > payload.json

          curl -H "Content-Type: application/json" \
            -X POST \
            -d @payload.json \
            "$WEBHOOK"
